<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Github API Access</title>  
</head>
<body>
    
    <!--
        The codes are adapted from:https://github.com/hnasr/javascript_playground/blob/master/githubtutorial/index.html

    -->
    <h1>Github API Access for google-research/google-research repository</h1>
    <button id = 'btnRepos'>Repos</button> 
    <!--<button id = 'btnIssues'>Issues</button>-->
    <button id = 'btnCommits'>Commits</button>
    <button id = 'btnCollaborators'>Collaborators</button>

    <div id = 'divResult'>

    </div>

    <script>
    const btnRepos = document.getElementById("btnRepos")
    //const btnIssues = document.getElementById("btnIssues")
    const btnCommits = document.getElementById("btnCommits")
    const btnCollaborators = document.getElementById("btnCollaborators")
    const divResult = document.getElementById("divResult")
    
    btnRepos.addEventListener("click", getRepos)
    //btnIssues.addEventListener("click", getIssues)
    btnCollaborators.addEventListener("click", getCollaborators)
    btnCommits.addEventListener("click", e=> getCommits())


    
    async function getRepos() {
        clear();
        const url = "https://api.github.com/search/repositories?q=google-research in:name user:google-research"
        const response = await fetch(url)
        const result = await response.json()

        const wanted_repo = result.items[0]
        const repo_name = document.createElement("p")
        repo_name.innerHTML = "Repository owner/Repository name:";
        divResult.appendChild(repo_name)


        const anchor = document.createElement("a")
        anchor.href = wanted_repo.html_url;
        anchor.textContent = wanted_repo.full_name;
        divResult.appendChild(anchor)
        divResult.appendChild(document.createElement("br"))

    }


    //https://api.github.com/search/commits?q=repo:google-research/google-research

    async function getCommits(url="https://api.github.com/repos/google-research/google-research/commits") {
        clear();
        
        const headers = {
            "Accept" : "application/vnd.github.cloak-preview"
        }
        const response = await fetch(url, {
            "method" : "GET",
            "headers" : headers
        })
    
        const link = response.headers.get("link")
        const links = link.split(",")
        const urls = links.map(a=> {
            return {
                url: a.split(";")[0].replace(">","").replace("<",""),
                title:a.split(";")[1]
            }

        })
        const result = await response.json()

        result.forEach(i=>{

            const authorname_date = document.createElement("span")
            authorname_date.innerHTML = i.commit.author.name + " " + i.commit.author.date + " ";
            divResult.appendChild(authorname_date)


            const anchor = document.createElement("a")
            anchor.href = i.html_url;
            anchor.textContent = i.commit.message.substr(0,100) + "...";
            
            divResult.appendChild(anchor)
            divResult.appendChild(document.createElement("br"))
        })


        urls.forEach(u => {
            const btn = document.createElement("button")
            btn.textContent = u.title;
            btn.addEventListener("click", e=> getCommits(u.url))
            divResult.appendChild(btn);

            const space = document.createElement("span")
            space.innerHTML = "&nbsp;&nbsp;&nbsp;";
            divResult.appendChild(space)
        })

    }

    async function getUsers(Username,data){
        const url = "https://api.github.com/users/" + Username 
        const response = await fetch(url)
        const result = await response.json()
        data["name"] = result.name;
        data["company"] = result.company;
        data["location"] = result.location;

    }

    async function getCollaborators() {
        clear();
        const url = "https://api.github.com/repos/google-research/google-research/stats/contributors"

        const headers = {
            "Accept" : "application/vnd.github.hellcat-preview+json",
            "Authorization" : "token 1db4b671265287b215bb2c42e9489bb4fdc6dfa4"
        }
        const response = await fetch(url, {
            "method" : "GET",
            "headers" : headers
        })

        const result = await response.json()

        const title_name = document.createElement("p")
        title_name.innerHTML = "Top 100 Collaborators name(Ordered by the count of commits):"
        divResult.appendChild(title_name)

        const save_users = document.createElement("button")
        divResult.appendChild(save_users);
        divResult.appendChild(document.createElement("br")) 
        divResult.appendChild(document.createElement("br")) 
        save_users.textContent = "Save users info"
        save_users.onclick = function(){
            saveHandler_user(datas);
        }


        const table = document.createElement("table")
        table.border = 1
        table.borderColor = "black"
        table.borderBottomStyle = "solid"
        const tr = document.createElement("tr")
        const th1 = document.createElement("th")
        const th2 = document.createElement("th")
        const th3 = document.createElement("th")
        const th4 = document.createElement("th")
        const th5 = document.createElement("th")

        divResult.appendChild(table);
        table.appendChild(tr);
        tr.appendChild(th1);
        th1.textContent = "User_name";
        tr.appendChild(th2);
        th2.textContent = "User_url";
        tr.appendChild(th3)
        th3.textContent = "Commits_count"
        tr.appendChild(th4)
        th4.textContent = "LOC added"
        tr.appendChild(th5)
        th5.textContent = "LOC Deleted"

        var datas=[];
            
        
        for ( var j = result.length-1; j > -1 ; j--){
            const i = result[j]
            const rank = 100 - j
        
            const tr_infor = document.createElement("tr")
            table.appendChild(tr_infor);
            const td1 = document.createElement("td")
            tr_infor.appendChild(td1)
            td1.innerHTML = rank + "&nbsp;" + i.author.login + "&nbsp;";
            const td2 = document.createElement("td")
            td2.align = "middle";
            const anchor = document.createElement("a")
            anchor.href = i.author.html_url;
            anchor.textContent = i.author.login;
            td2.appendChild(anchor)
            tr_infor.appendChild(td2)


            const td3 = document.createElement("td")
            td3.align = "middle";
            tr_infor.appendChild(td3)
            td3.innerHTML = i.total;

            const td4 = document.createElement("td")
            td4.align = "middle";
            tr_infor.appendChild(td4)
            var loc_add = 0;
            for( var x = 0 ; x < i.weeks.length; x++){
                loc_add += i.weeks[x].a;
            }
            td4.innerHTML = loc_add;

            const td5 = document.createElement("td")
            td5.align = "middle";
            tr_infor.appendChild(td5)
            var loc_delete = 0;
            for( var x = 0 ; x < i.weeks.length; x++){
                loc_delete += i.weeks[x].d;
            }
            td5.innerHTML = loc_delete;

		    var data = {};
		    data["Login_name"] = i.author.login;
		    data["Commits_count"] = i.total;
		    data["LOC_added"] = loc_add;
            data["LOC_deleted"] = loc_delete;
            getUsers(i.author.login, data)
		    datas.push(data);

        }

    }
    



    function clear(){
        while(divResult.firstChild) 
            divResult.removeChild(divResult.firstChild)
    }
    </script>

    <script src="https://cdn.bootcss.com/FileSaver.js/2014-11-29/FileSaver.js"></script>
    <script>
        function saveHandler(opencount, closecount){
           let data = {
               Open_issues_count: opencount,
               Closed_issues_count: closecount
       }
           var content = JSON.stringify(data);
           var blob = new Blob([content], {type: "text/plain;charset=utf-8"});
           saveAs(blob, "Save_issues_count(demo).json");
       }

       function saveHandler_user(datas){
           var content = JSON.stringify(datas);
           var blob = new Blob([content], {type: "text/plain;charset=utf-8"});
           saveAs(blob, "Save_users.json");
       }
    </script>
</body>
</html>