<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Using d3 to show data</title>  
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
    <h1>D3 visualization for google-research/google-research repository</h1>

    <div>
        <!--<input type="file" id="files" name="Select file"/>-->
        <input type="file" name="select_file" id="files" style="visibility:hidden;"><br>
        <input type="button" onclick="SelectFile()" value="Select file"><br><br><br>

    </div>


    <script>
        var datas;
        var valid_user = new Array();
        var valid_count = 0;
        var location_name = new Array();

        var USA = new Array();
        var UK = new Array();
        var Canada = new Array();
        var Germany = new Array();
        var Swiss = new Array();
        var France = new Array();

        function filter_data(){
            for ( var i = 0; i < datas.length ; i++){
                if(datas[i].location != null){
                    valid_user[valid_count] = datas[i];
                    //valid_user[valid_count].location = valid_user[valid_count].location.split(",",1)
                    valid_count++;
                }
            }

            //location_name.push(valid_user[0].location)
            for( var i = 0 ; i < valid_count ; i++){
                var is_duplicate = false;
                if(location_name.length == 0){
                    location_name.push(valid_user[i].location);
                }else{
                    for( var j = 0 ; j < location_name.length ; j++){
                        if(valid_user[i].location == location_name[j]){
                            is_duplicate = true;
                        }
                    }

                    if(is_duplicate == false){
                        location_name.push(valid_user[i].location);
                    }
                }
            }

            

            for (var i = 0 ; i < valid_count; i++){
                var temp = valid_user[i].location;
                if(temp == "London, UK" || temp == "London"){
                    UK.push(temp);
                }else if(temp == "Montreal" || temp == "Toronto"){
                    Canada.push(temp);
                }else if(temp == "Tübingen"){
                    Germany.push(temp);
                }else if(temp == "Zürich"){
                    Swiss.push(temp);
                }else if(temp == "Paris"){
                    France.push(temp);
                }else{
                    USA.push(temp);
                }
            }

            display_piechart_country();



        }

        function display_piechart_country(){
            var USA_count = USA.length;
            var UK_count = UK.length;
            var Canada_count = Canada.length;
            var Germany_count = Germany.length;
            var Swiss_count = Swiss.length;
            var France_count = France.length;

            var width = 600;
            var height = 600;

            var title = d3.select("body")
                    .append("p")
                    .text("1. Total Commits compare for different countries in top 100 contributors who has location information")
                    .style("color", "black");
            var svg = d3.select("body")
					.append("svg")
					.attr("width", width)
					.attr("height", height);

            var tooltip = d3.select("body").append("div").attr("class", "toolTip");

            var color = d3.scaleOrdinal(["#74F590", "#F56464", "#64BCF5"]);
            g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + (height/2) + ")");

            var pie = d3.pie()
                .sort(null)
                .value(function(d) { return d.value; });
            var radius = 250
            var path = d3.arc()
                .outerRadius(radius)
                .innerRadius(35);

            var path0 = d3.arc()
                .outerRadius(radius+10)
                .innerRadius(35);

            var label = d3.arc()
                .outerRadius(radius - 20)
                .innerRadius(radius - 20);

            var label0 = d3.arc()
                .outerRadius(radius + 20)
                .innerRadius(radius + 20);


            var data = [
                {"area":"USA","value": USA_count},
                {"area":"UK", "value": UK_count},
                {"area":"Canada", "value":Canada_count},
                {"area":"Germany","value":Germany_count},
                {"area":"Swiss","value":Swiss_count},
                {"area":"France","value":France_count}
            ];


            var arc = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arc.on("mouseover",function(d,i){
                d3.select(this).select("path")
                .attr("d",path0);
            tooltip
                .style("left", d3.event.pageX - 50 + "px")
                .style("top", d3.event.pageY - 70 + "px")
                .style("display", "inline-block")
                .html(
                    "<div>"+(d.data.area) +"</div>"+
                    "<div class='clearfix'><div class='pull-left toolTipCircle circle1'></div><div class='pull-left'>"+"Commits count："+(d.value)+"</div></div>"
                );
            });

            arc.on("mouseout",function(d,i){
                d3.select(this).select("path")
                .attr("d",path);
                tooltip.style("display", "none");
            });

            arc.append("path")
                .attr("d", path)
                .attr("fill", function(d) { return color(d.data.area); });

            arc.append("text")
                .attr("transform", function(d) {
                    var x2 =label0.centroid(d)[0];
                    var y2 =label0.centroid(d)[1];
                    var x3 = x2<0?x2-70:x2+30;
                    return "translate(" + x3 + "," + y2 + ")";
                })
                .attr("dy", "0.3em")
                .text(function(d) { return d.data.area; });

            arc.append("polyline")
                .attr("points",function(d){
                    var x1 =label.centroid(d)[0];
                    var y1 =label.centroid(d)[1];
                    var x2 =label0.centroid(d)[0];
                    var y2 =label0.centroid(d)[1];
                    var x3 = x2<0?x2-30:x2+30;
                    return x3+","+y2+" "+x2+","+y2+" "+x1+","+y1;
                })
                .style("fill","none")
                .style("stroke","rgb(99,99,99)")
                .style("stroke-width","2")
		



        }

        function SelectFile()
        {
            files.click();
        }

        var inputElement = document.getElementById("files");
        inputElement.addEventListener("change", handleFiles, false);

        function handleFiles() {
            var selectedFile = document.getElementById("files").files[0];// get the file read object
            var name = selectedFile.name;
            var size = selectedFile.size;
            var reader = new FileReader();
            
            
            var data_length;
            reader.onload = function(){
                let json = JSON.parse(this.result);
                datas = json;
                filter_data();
                return;
                
            }; 
            reader.readAsText(selectedFile);        
        }

        

    
    </script>



</body>