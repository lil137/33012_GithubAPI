<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Using d3 to show data</title>  
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
    <h1>D3 visualization for google-research/google-research repository</h1>

    <div id="buttons">
        <input type="file" name="select_file" id="files1" style="visibility:hidden;"><br>
        <input type="button" onclick="SelectFile1()" value="load the file Save_users.json"><br>

        <input type="file" name="select_file" id="files2" style="visibility:hidden;"><br>
        <input type="button" onclick="SelectFile2()" value="load the file Save_commits.json"><br>

        <input type="file" name="select_file" id="files3" style="visibility:hidden;"><br>
        <input type="button" onclick="SelectFile3()" value="load the file Save_code_frequency.json"><br>
    </div>

    <div id="display_user"></div>
    <div id="display_commits"></div>
    <div id="display_code_frequency"></div>


    <script>
        var datas;
        var valid_user = new Array();
        var valid_count = 0;
        var location_name = new Array();

        var USA = new Array();
        var UK = new Array();
        var Canada = new Array();
        var Germany = new Array();
        var Swiss = new Array();
        var France = new Array();

        var USA_loc = new Array();
        var UK_loc = new Array();
        var Canada_loc = new Array();
        var Germany_loc = new Array();
        var Swiss_loc = new Array();
        var France_loc = new Array();

        var weekly_add = new Array();
        var weekly_delete = new Array();

        function filter_data_user(){
            for ( var i = 0; i < datas.length ; i++){
                if(datas[i].location != null){
                    valid_user[valid_count] = datas[i];
                    //valid_user[valid_count].location = valid_user[valid_count].location.split(",",1)
                    valid_count++;
                }
            }

            //location_name.push(valid_user[0].location)
            for( var i = 0 ; i < valid_count ; i++){
                var is_duplicate = false;
                if(location_name.length == 0){
                    location_name.push(valid_user[i].location);
                }else{
                    for( var j = 0 ; j < location_name.length ; j++){
                        if(valid_user[i].location == location_name[j]){
                            is_duplicate = true;
                        }
                    }

                    if(is_duplicate == false){
                        location_name.push(valid_user[i].location);
                    }
                }
            }

            for (var i = 0 ; i < valid_count; i++){
                var temp = valid_user[i].location;
                var loc_a = valid_user[i].LOC_added;
                var loc_d = valid_user[i].LOC_deleted;
                if(temp == "London, UK" || temp == "London"){
                    UK.push(temp);
                    UK_loc.push(loc_a);
                    UK_loc.push(loc_d);
                }else if(temp == "Montreal" || temp == "Toronto"){
                    Canada.push(temp);
                    Canada_loc.push(loc_a);
                    Canada_loc.push(loc_d);
                }else if(temp == "Tübingen"){
                    Germany.push(temp);
                    Germany_loc.push(loc_a);
                    Germany_loc.push(loc_d);
                }else if(temp == "Zürich"){
                    Swiss.push(temp);
                    Swiss_loc.push(loc_a);
                    Swiss_loc.push(loc_d);
                }else if(temp == "Paris"){
                    France.push(temp);
                    France_loc.push(loc_a);
                    France_loc.push(loc_d);
                }else{
                    USA.push(temp);
                    USA_loc.push(loc_a);
                    USA_loc.push(loc_d);
                }
            }

            clear();
            display_piechart_country();
            display_piechart_loc_a();
            display_piechart_loc_d();



        }

        function filter_data_code_frequency(){
            clear();
            const code_frequency_result = datas
            
            for ( var i  = 0 ; i < code_frequency_result.length ; i++){
                weekly_add.push(code_frequency_result[i][1]);
                weekly_delete.push(code_frequency_result[i][2]);
            }

            display_barchart_code_frequency();
        }

        function display_barchart_code_frequency(){
	        var width = 1400;
	        var height = 700;

            const title = document.createElement("p")
            title.innerHTML = "The number of loc added since the first week"
            display_code_frequency.appendChild(title)

	        var svg = d3.select("body")
                .select("#display_code_frequency")
		        .append("svg")
		        .attr("width", width)
		        .attr("height", height);

	        var padding = {left:50, right:30, top:20, bottom:20};

            var dataset = weekly_add;
	        var xScale = d3.scaleBand()
		        .domain(d3.range(dataset.length))
		        .range([0, width - padding.left - padding.right]);

	    
	        var yScale = d3.scaleLinear()
		        .domain([0,d3.max(dataset)])
		        .range([height - padding.top - padding.bottom, 0]);

            var xAxis = d3.axisBottom(xScale).tickFormat(function(d){ return d;});
            var yAxis = d3.axisLeft(yScale);

	        var rectPadding = 4;

	        var rects = svg.selectAll(".MyRect")
		        .data(dataset)
		        .enter()
		        .append("rect")
                .attr("fill","steelblue")
		        .attr("transform","translate(" + padding.left + "," + padding.top + ")")
		        .attr("x", function(d,i){
			        return xScale(i) + rectPadding/2;
		        } )
		        .attr("y",function(d){
			        return yScale(d);
		        })
		        .attr("width", xScale.bandwidth() - rectPadding )
		        .attr("height", function(d){
			        return height - padding.top - padding.bottom - yScale(d);
		        });

	            var texts = svg.selectAll(".MyText")
		            .data(dataset)
		            .enter()
		            .append("text")
                    .attr("text-anchor","middle")
                    .attr("font-size", 8)
		            .attr("transform","translate(" + padding.left + "," + -5 + ")")
		            .attr("x", function(d,i){
			            return xScale(i) + rectPadding/2;
		            })
		            .attr("y",function(d){
			            return yScale(d);
		            })
		            .attr("dx",function(){
			            return (xScale.bandwidth() - rectPadding)/2;
		            })
		            .attr("dy",function(d){
			            return 20;
		            })
		            .text(function(d){
			            return d;
		            })

	            svg.append("g")
		            .attr("transform","translate(" + padding.left + "," + (height - padding.bottom) + ")")
		            .call(xAxis); 
		
	            svg.append("g")
		            .attr("transform","translate(" + padding.left + "," + padding.top + ")")
		            .call(yAxis);
            
        }

        function filter_data_commits(){
            clear();
        }

        function display_barchart_commits(){

            
        }



        function display_piechart_country(){
            var USA_count = USA.length;
            var UK_count = UK.length;
            var Canada_count = Canada.length;
            var Germany_count = Germany.length;
            var Swiss_count = Swiss.length;
            var France_count = France.length;

            var width = 600;
            var height = 600;

            var title = d3.select("body")
                    .select("#display_user")
                    .append("p")
                    .text("1. Total Commits compare for different countries in top 100 contributors who has location information")
                    .style("color", "black");
            var svg = d3.select("body")
                    .select("#display_user")
					.append("svg")
					.attr("width", width)
					.attr("height", height);

            var tooltip = d3.select("body").select("#display_user").append("div").attr("class", "toolTip");

            var color = d3.scaleOrdinal(["#74F590", "#F56464", "#64BCF5"]);
            g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + (height/2) + ")");

            var pie = d3.pie()
                .sort(null)
                .value(function(d) { return d.value; });
            var radius = 250
            var path = d3.arc()
                .outerRadius(radius)
                .innerRadius(20);

            var path0 = d3.arc()
                .outerRadius(radius+10)
                .innerRadius(35);

            var label = d3.arc()
                .outerRadius(radius - 20)
                .innerRadius(radius - 20);

            var label0 = d3.arc()
                .outerRadius(radius + 20)
                .innerRadius(radius + 20);


            var data = [
                {"area":"USA","value": USA_count},
                {"area":"UK", "value": UK_count},
                {"area":"Canada", "value":Canada_count},
                {"area":"Germany","value":Germany_count},
                {"area":"Swiss","value":Swiss_count},
                {"area":"France","value":France_count}
            ];


            var arc = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arc.on("mouseover",function(d,i){
                d3.select(this).select("path")
                .attr("d",path0);
            tooltip
                .style("left", d3.event.pageX - 50 + "px")
                .style("top", d3.event.pageY - 70 + "px")
                .style("display", "inline-block")
                .html(
                    "<div>"+(d.data.area) +"</div>"+
                    "<div class='clearfix'><div class='pull-left toolTipCircle circle1'></div><div class='pull-left'>"+"Commits count："+(d.value)+"</div></div>"
                );
            });

            arc.on("mouseout",function(d,i){
                d3.select(this).select("path")
                .attr("d",path);
                tooltip.style("display", "none");
            });

            arc.append("path")
                .attr("d", path)
                .attr("fill", function(d) { return color(d.data.area); });

            arc.append("text")
                .attr("transform", function(d) {
                    var x2 =label0.centroid(d)[0];
                    var y2 =label0.centroid(d)[1];
                    var x3 = x2<0?x2-70:x2+30;
                    return "translate(" + x3 + "," + y2 + ")";
                })
                .attr("dy", "0.3em")
                .text(function(d) { return d.data.area; });

            arc.append("polyline")
                .attr("points",function(d){
                    var x1 =label.centroid(d)[0];
                    var y1 =label.centroid(d)[1];
                    var x2 =label0.centroid(d)[0];
                    var y2 =label0.centroid(d)[1];
                    var x3 = x2<0?x2-30:x2+30;
                    return x3+","+y2+" "+x2+","+y2+" "+x1+","+y1;
                })
                .style("fill","none")
                .style("stroke","rgb(99,99,99)")
                .style("stroke-width","2")
		
        }

        function display_piechart_loc_a(){

            var width = 700;
            var height = 600;

            var title = d3.select("body")
                    .select("#display_user")
                    .append("p")
                    .text("2. Total LOC ADDED for different countries in top 100 contributors who has location information")
                    .style("color", "black");
            var svg = d3.select("body")
                    .select("#display_user")
					.append("svg")
					.attr("width", width)
					.attr("height", height);

            var tooltip = d3.select("body").select("#display_user").append("div").attr("class", "toolTip");

            var color = d3.scaleOrdinal(["#74F590", "#F56464", "#64BCF5"]);
            g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + (height/2) + ")");

            var pie = d3.pie()
                .sort(null)
                .value(function(d) { return d.value; });
            var radius = 250
            var path = d3.arc()
                .outerRadius(radius)
                .innerRadius(20);

            var path0 = d3.arc()
                .outerRadius(radius+10)
                .innerRadius(35);

            var label = d3.arc()
                .outerRadius(radius - 20)
                .innerRadius(radius - 20);

            var label0 = d3.arc()
                .outerRadius(radius + 20)
                .innerRadius(radius + 20);


            var data = [
                {"area":"USA","value": USA_loc[0]},
                {"area":"UK", "value": UK_loc[0]},
                {"area":"Canada", "value":Canada_loc[0]},
                {"area":"Germany","value":Germany_loc[0]},
                {"area":"Swiss","value":Swiss_loc[0]},
                {"area":"France","value":France_loc[0]}
            ];


            var arc = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arc.on("mouseover",function(d,i){
                d3.select(this).select("path")
                .attr("d",path0);
            tooltip
                .style("left", d3.event.pageX - 50 + "px")
                .style("top", d3.event.pageY - 70 + "px")
                .style("display", "inline-block")
                .html(
                    "<div>"+(d.data.area) +"</div>"+
                    "<div class='clearfix'><div class='pull-left toolTipCircle circle1'></div><div class='pull-left'>"+"LOC ADDED："+(d.value)+"</div></div>"
                );
            });

            arc.on("mouseout",function(d,i){
                d3.select(this).select("path")
                .attr("d",path);
                tooltip.style("display", "none");
            });

            arc.append("path")
                .attr("d", path)
                .attr("fill", function(d) { return color(d.data.area); });

            arc.append("text")
                .attr("transform", function(d) {
                    var x2 =label0.centroid(d)[0];
                    var y2 =label0.centroid(d)[1];
                    var x3 = x2<0?x2-70:x2+30;
                    return "translate(" + x3 + "," + y2 + ")";
                })
                .attr("dy", "0.3em")
                .text(function(d) { return d.data.area; });

            arc.append("polyline")
                .attr("points",function(d){
                    var x1 =label.centroid(d)[0];
                    var y1 =label.centroid(d)[1];
                    var x2 =label0.centroid(d)[0];
                    var y2 =label0.centroid(d)[1];
                    var x3 = x2<0?x2-30:x2+30;
                    return x3+","+y2+" "+x2+","+y2+" "+x1+","+y1;
                })
                .style("fill","none")
                .style("stroke","rgb(99,99,99)")
                .style("stroke-width","2")
	
        }

        function display_piechart_loc_d(){
        
            var width = 600;
            var height = 600;

            var title = d3.select("body")
                    .select("#display_user")
                    .append("p")
                    .text("3. Total LOC DELETED for different countries in top 100 contributors who has location information")
                    .style("color", "black");
            var svg = d3.select("body")
                    .select("#display_user")
					.append("svg")
					.attr("width", width)
					.attr("height", height);

            var tooltip = d3.select("body").select("#display_user").append("div").attr("class", "toolTip");

            var color = d3.scaleOrdinal(["#74F590", "#F56464", "#64BCF5"]);
            g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + (height/2) + ")");

            var pie = d3.pie()
                .sort(null)
                .value(function(d) { return d.value; });
            var radius = 250
            var path = d3.arc()
                .outerRadius(radius)
                .innerRadius(20);

            var path0 = d3.arc()
                .outerRadius(radius+10)
                .innerRadius(35);

            var label = d3.arc()
                .outerRadius(radius - 20)
                .innerRadius(radius - 20);

            var label0 = d3.arc()
                .outerRadius(radius + 20)
                .innerRadius(radius + 20);


            var data = [
                {"area":"UK, Canada, Germany and France", "value": UK_loc[1] + Canada_loc[1] + Germany_loc[1] + France_loc[1]},
                {"area":"USA","value": USA_loc[1]},
                
                {"area":"Swiss","value":Swiss_loc[1]},
                
            ];


            var arc = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arc.on("mouseover",function(d,i){
                d3.select(this).select("path")
                .attr("d",path0);
            tooltip
                .style("left", d3.event.pageX - 50 + "px")
                .style("top", d3.event.pageY - 70 + "px")
                .style("display", "inline-block")
                .html(
                    "<div>"+(d.data.area) +"</div>"+
                    "<div class='clearfix'><div class='pull-left toolTipCircle circle1'></div><div class='pull-left'>"+"LOC DELETED："+(d.value)+"</div></div>"
                );
            });

            arc.on("mouseout",function(d,i){
                d3.select(this).select("path")
                .attr("d",path);
                tooltip.style("display", "none");
            });

            arc.append("path")
                .attr("d", path)
                .attr("fill", function(d) { return color(d.data.area); });

            arc.append("text")
                .attr("transform", function(d) {
                    var x2 =label0.centroid(d)[0];
                    var y2 =label0.centroid(d)[1];
                    var x3 = x2<0?x2-70:x2+30;
                    return "translate(" + x3 + "," + y2 + ")";
                })
                .attr("dy", "0.3em")
                .text(function(d) { return d.data.area; });

            arc.append("polyline")
                .attr("points",function(d){
                    var x1 =label.centroid(d)[0];
                    var y1 =label.centroid(d)[1];
                    var x2 =label0.centroid(d)[0];
                    var y2 =label0.centroid(d)[1];
                    var x3 = x2<0?x2-30:x2+30;
                    return x3+","+y2+" "+x2+","+y2+" "+x1+","+y1;
                })
                .style("fill","none")
                .style("stroke","rgb(99,99,99)")
                .style("stroke-width","2")
	
        }


        function clear(){
            while(display_user.firstChild){ 
                display_user.removeChild(display_user.firstChild)
            }

            while(display_commits.firstChild){ 
                display_commits.removeChild(display_commits.firstChild)
            }

            while(display_code_frequency.firstChild){ 
                display_code_frequency.removeChild(display_code_frequency.firstChild)
            }
        }

        function SelectFile1()
        {
            files1.click();
        }

        var inputElement = document.getElementById("files1");
        inputElement.addEventListener("change", handleFiles1, false);

        function handleFiles1() {
            var selectedFile = document.getElementById("files1").files[0];// get the file read object
            var name = selectedFile.name;
            var size = selectedFile.size;
            var reader = new FileReader();
            
            
            var data_length;
            reader.onload = function(){
                let json = JSON.parse(this.result);
                datas = json;
                filter_data_user();
                return;
                
            }; 
            reader.readAsText(selectedFile);        
        }

        function SelectFile2()
        {
            files2.click();
        }

        var inputElement = document.getElementById("files2");
        inputElement.addEventListener("change", handleFiles2, false);

        function handleFiles2() {
            var selectedFile = document.getElementById("files2").files[0];// get the file read object
            var name = selectedFile.name;
            var size = selectedFile.size;
            var reader = new FileReader();
            
            
            var data_length;
            reader.onload = function(){
                let json = JSON.parse(this.result);
                datas = json;
                filter_data_commits();
                return;
                
            }; 
            reader.readAsText(selectedFile);        
        }

        function SelectFile3()
        {
            files3.click();
        }

        var inputElement = document.getElementById("files3");
        inputElement.addEventListener("change", handleFiles3, false);

        function handleFiles3() {
            var selectedFile = document.getElementById("files3").files[0];// get the file read object
            var name = selectedFile.name;
            var size = selectedFile.size;
            var reader = new FileReader();
            
            
            var data_length;
            reader.onload = function(){
                let json = JSON.parse(this.result);
                datas = json;
                filter_data_code_frequency();
                return;
                
            }; 
            reader.readAsText(selectedFile);        
        }

        

    
    </script>



</body>